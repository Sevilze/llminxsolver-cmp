name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  linux:
    name: Linux Build (Deb, Rpm, Tar.gz) & AUR
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Native Library
        run: |
          cargo build -p llminxsolver-uniffi --release
          mkdir -p composeApp/src/desktopMain/resources
          cp target/release/libllminxsolver_uniffi.so composeApp/src/desktopMain/resources/

      - name: Build Desktop Packages
        run: |
          chmod +x gradlew
          ./gradlew :composeApp:packageDeb :composeApp:packageRpm :composeApp:createDistributable

      - name: Prepare Artifacts
        run: |
          mkdir -p dist

          cp -r composeApp/build/compose/binaries/main/app/* dist/

          cd dist
          tar -czvf ../llminxsolver-${{ github.ref_name }}-x86_64-linux.tar.gz *
          cd ..

          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          echo "SHA256=$(sha256sum llminxsolver-${{ github.ref_name }}-x86_64-linux.tar.gz | awk '{print $1}')" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            llminxsolver-${{ github.ref_name }}-x86_64-linux.tar.gz
            composeApp/build/compose/binaries/main/deb/*.deb
            composeApp/build/compose/binaries/main/rpm/*.rpm
          generate_release_notes: true

      - name: Update PKGBUILD
        run: |
          sed -i "s/^pkgver=.*/pkgver=${{ env.VERSION }}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          sed -i "s/^sha256sums=.*/sha256sums=('${{ env.SHA256 }}')/" PKGBUILD
          cat PKGBUILD

      - name: Update AUR
        uses: KSXGitHub/github-actions-deploy-aur@v2.2.5
        with:
          pkgname: llminxsolver-bin
          pkgbuild: ./PKGBUILD
          commit_username: Sevilze
          commit_email: sevilzcubing@gmail.com
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to v${{ env.VERSION }}"
          force_push: false
          ssh_keyscan_types: rsa,ecdsa,ed25519

      - name: Update 'latest' tag
        run: |
          git tag -f latest
          git push -f origin latest

  windows:
    name: Windows Build (Exe)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Native Library
        run: |
          cargo build -p llminxsolver-uniffi --release
          New-Item -ItemType Directory -Force -Path composeApp/src/desktopMain/resources
          Copy-Item target/release/llminxsolver_uniffi.dll composeApp/src/desktopMain/resources/

      - name: Generate Windows Icon
        run: |
          choco install imagemagick -y --no-progress
          $magick = (Get-ChildItem "C:\Program Files\ImageMagick-*\magick.exe" | Select-Object -First 1).FullName
          if (!$magick) { Write-Error "ImageMagick not found"; exit 1 }
          & $magick composeApp/icons/manimicon.png -define icon:auto-resize=256,128,64,48,32,16 composeApp/icons/manimicon.ico
          if (!(Test-Path composeApp/icons/manimicon.ico)) {
            Write-Error "Failed to create manimicon.ico"
            exit 1
          }
        shell: pwsh

      - name: Build Desktop Package
        run: ./gradlew :composeApp:packageExe --stacktrace

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: composeApp/build/compose/binaries/main/exe/*.exe

  macos:
    name: macOS Build (Dmg)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin, aarch64-apple-darwin

      - name: Build Universal Native Library
        run: |
          cargo build -p llminxsolver-uniffi --release --target x86_64-apple-darwin
          cargo build -p llminxsolver-uniffi --release --target aarch64-apple-darwin

          mkdir -p composeApp/src/desktopMain/resources
          lipo -create \
            target/x86_64-apple-darwin/release/libllminxsolver_uniffi.dylib \
            target/aarch64-apple-darwin/release/libllminxsolver_uniffi.dylib \
            -output composeApp/src/desktopMain/resources/libllminxsolver_uniffi.dylib

      - name: Generate macOS Icon
        run: |
          mkdir -p composeApp/icons/manimicon.iconset
          sips -z 16 16     composeApp/icons/manimicon.png --out composeApp/icons/manimicon.iconset/icon_16x16.png
          sips -z 32 32     composeApp/icons/manimicon.png --out composeApp/icons/manimicon.iconset/icon_16x16@2x.png
          sips -z 32 32     composeApp/icons/manimicon.png --out composeApp/icons/manimicon.iconset/icon_32x32.png
          sips -z 64 64     composeApp/icons/manimicon.png --out composeApp/icons/manimicon.iconset/icon_32x32@2x.png
          sips -z 128 128   composeApp/icons/manimicon.png --out composeApp/icons/manimicon.iconset/icon_128x128.png
          sips -z 256 256   composeApp/icons/manimicon.png --out composeApp/icons/manimicon.iconset/icon_128x128@2x.png
          sips -z 256 256   composeApp/icons/manimicon.png --out composeApp/icons/manimicon.iconset/icon_256x256.png
          sips -z 512 512   composeApp/icons/manimicon.png --out composeApp/icons/manimicon.iconset/icon_256x256@2x.png
          sips -z 512 512   composeApp/icons/manimicon.png --out composeApp/icons/manimicon.iconset/icon_512x512.png
          sips -z 1024 1024 composeApp/icons/manimicon.png --out composeApp/icons/manimicon.iconset/icon_512x512@2x.png
          iconutil -c icns composeApp/icons/manimicon.iconset -o composeApp/icons/icon.icns

      - name: Build Desktop Package
        run: |
          chmod +x gradlew
          ./gradlew :composeApp:packageDmg

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: composeApp/build/compose/binaries/main/dmg/*.dmg
