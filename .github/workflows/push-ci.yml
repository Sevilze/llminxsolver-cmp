name: Push CI

on:
  push:
    branches:
      - main
      - master
    paths:
      - "Cargo.lock"
      - "Cargo.toml"
      - "llminxsolver-rs/**"
      - "llminxsolver-uniffi/**"
      - "shared/**"
      - "androidApp/**"
      - "desktopApp/**"
      - "gradle/**"
      - "build.gradle.kts"
      - "settings.gradle.kts"
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  check-gradle-deps:
    name: Check Gradle Deps Hash
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Gradle Deps Staleness
        run: |
          GRADLE_FILES="gradle/libs.versions.toml build.gradle.kts settings.gradle.kts desktopApp/build.gradle.kts shared/build.gradle.kts androidApp/build.gradle.kts"
          HASH_FILE="nix/gradle-deps.nix"

          GRADLE_COMMIT=$(git log -1 --format="%H" -- $GRADLE_FILES 2>/dev/null || echo "")
          HASH_COMMIT=$(git log -1 --format="%H" -- $HASH_FILE 2>/dev/null || echo "")

          if [ -z "$GRADLE_COMMIT" ] || [ -z "$HASH_COMMIT" ]; then
            echo "Could not determine commit history, skipping check"
            exit 0
          fi

          if git merge-base --is-ancestor "$HASH_COMMIT" "$GRADLE_COMMIT" 2>/dev/null; then
            echo "Gradle files were modified after nix/gradle-deps.nix. The hash may be stale."
          else
            echo "Gradle deps hash appears up to date."
          fi

  cache-linux:
    name: Cache (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          workflow-job-context: gradle-linux
          cache-cleanup: never

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-linux

      - name: Build Rust Library
        run: cargo build -p llminxsolver-uniffi --release

      - name: Warm Gradle Cache
        run: |
          chmod +x gradlew
          ./gradlew :shared:compileKotlinDesktop --no-daemon --dependency-verification=off

  cache-macos-arm:
    name: Cache (macOS ARM)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          workflow-job-context: gradle-macos-arm
          cache-cleanup: never

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-macos-arm

      - name: Build Rust Library
        run: cargo build -p llminxsolver-uniffi --release

      - name: Warm Gradle Cache
        run: |
          chmod +x gradlew
          ./gradlew :shared:compileKotlinDesktop --no-daemon --dependency-verification=off

  cache-macos-intel:
    name: Cache (macOS Intel)
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          workflow-job-context: gradle-macos-intel
          cache-cleanup: never

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-macos-intel

      - name: Build Rust Library
        run: cargo build -p llminxsolver-uniffi --release

      - name: Warm Gradle Cache
        run: |
          chmod +x gradlew
          ./gradlew :shared:compileKotlinDesktop --no-daemon --dependency-verification=off

  cache-windows:
    name: Cache (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          workflow-job-context: gradle-windows
          cache-cleanup: never

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-windows

      - name: Build Rust Library
        run: cargo build -p llminxsolver-uniffi --release

      - name: Warm Gradle Cache
        run: .\gradlew.bat :shared:compileKotlinDesktop --no-daemon --dependency-verification=off

  cleanup-caches:
    name: Cleanup Old Caches
    needs: [cache-linux, cache-macos-arm, cache-macos-intel, cache-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Delete old caches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          echo "Fetching all caches..."
          caches=$(gh cache list --limit 1000 --json id,key,createdAt --jq 'sort_by(.createdAt) | reverse')

          declare -A prefix_counts
          declare -a to_delete=()

          while read -r cache; do
            [[ -z "$cache" ]] && continue
            id=$(echo "$cache" | jq -r '.id')
            key=$(echo "$cache" | jq -r '.key')

            prefix=""
            max_keep=1

            if [[ "$key" == v0-rust-* ]]; then
              # v0-rust-{shared-key}-{os}-{arch}-{hash}-{hash}
              # Keep 1 per OS/shared-key combination
              prefix=$(echo "$key" | sed -E 's/(v0-rust-[^-]+-[^-]+-[^-]+).*/\1/')
              max_keep=1
            elif [[ "$key" == gradle-home-* ]]; then
              # gradle-home-v1|{OS}-{Arch}|{job-context}[hash]-hash
              # Keep 1 per OS/job-context
              prefix=$(echo "$key" | sed -E 's/(gradle-home-[^|]+\|[^|]+\|[^[]+).*/\1/')
              max_keep=1
            elif [[ "$key" =~ ^gradle-[a-z-]+-v[0-9]+ ]]; then
              # All other gradle caches - keep up to 4 (one per OS variant)
              prefix=$(echo "$key" | sed -E 's/(gradle-[a-z-]+-v[0-9]+).*/\1/')
              max_keep=4
            else
              continue
            fi

            current_count=${prefix_counts[$prefix]:-0}
            if [[ $current_count -lt $max_keep ]]; then
              prefix_counts[$prefix]=$((current_count + 1))
              echo "KEEP  id=$id key=$key (count=${prefix_counts[$prefix]}/$max_keep for prefix: $prefix)"
            else
              echo "DELETE id=$id key=$key (exceeds $max_keep for prefix: $prefix)"
              to_delete+=("$id")
            fi
          done < <(echo "$caches" | jq -c '.[]')

          for id in "${to_delete[@]}"; do
            gh cache delete "$id" || true
          done

          echo "Cache cleanup complete."
