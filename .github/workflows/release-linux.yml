name: Linux Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  actions: read
  pull-requests: read

jobs:
  release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v6
        with:
          mode: "COMMIT"
          configuration: ".github/release-notes-config.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  nix:
    name: Nix Build & Cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            extra-experimental-features = nix-command flakes impure-derivations ca-derivations
            extra-substituters = https://llminxsolver-bin.cachix.org
            extra-trusted-public-keys = llminxsolver-bin.cachix.org-1:twj+Ti21Cwwuo77YXFHP2elmgYQgvmQuB0/dOam7NJY=

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: llminxsolver-bin
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          pushFilter: "(-source$|llminxsolver)"

      - name: Build with Nix
        run: |
          nix build .#lib
          nix build

  linux:
    name: Linux Build (Deb, Rpm, Tar.gz) & AUR
    needs: release-notes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          workflow-job-context: gradle-linux

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-linux
          save-if: false

      - name: Build Native Library
        run: |
          cargo build -p llminxsolver-uniffi --release
          mkdir -p shared/src/desktopMain/resources
          cp target/release/libllminxsolver_uniffi.so shared/src/desktopMain/resources/

      - name: Build Desktop Packages
        env:
          APP_VERSION: ${{ github.ref_name }}
        run: |
          export APP_VERSION=${APP_VERSION#v}
          chmod +x gradlew
          ./gradlew :desktopApp:packageReleaseDeb :desktopApp:packageReleaseRpm :desktopApp:createReleaseDistributable --dependency-verification=off

      - name: Prepare Artifacts
        run: |
          mkdir -p dist

          cp -r desktopApp/build/compose/binaries/main-release/app/* dist/

          cd dist
          tar -czvf ../llminxsolver-${{ github.ref_name }}-x86_64-linux.tar.gz *
          cd ..

          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          echo "SHA256=$(sha256sum llminxsolver-${{ github.ref_name }}-x86_64-linux.tar.gz | awk '{print $1}')" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            llminxsolver-${{ github.ref_name }}-x86_64-linux.tar.gz
            desktopApp/build/compose/binaries/main-release/deb/*.deb
            desktopApp/build/compose/binaries/main-release/rpm/*.rpm
          body: ${{ needs.release-notes.outputs.changelog }}

      - name: Update PKGBUILD
        run: |
          sed -i "s/^pkgver=.*/pkgver=${{ env.VERSION }}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          sed -i "s/^sha256sums=.*/sha256sums=('${{ env.SHA256 }}')/" PKGBUILD
          cat PKGBUILD

      - name: Update AUR
        uses: KSXGitHub/github-actions-deploy-aur@v2.2.5
        with:
          pkgname: llminxsolver-bin
          pkgbuild: ./PKGBUILD
          commit_username: Sevilze
          commit_email: sevilzcubing@gmail.com
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to v${{ env.VERSION }}"
          force_push: false
          ssh_keyscan_types: rsa,ecdsa,ed25519

      - name: Update 'latest' tag
        run: |
          git tag -f latest
          git push -f origin latest
